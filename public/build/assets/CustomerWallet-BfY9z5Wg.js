import{b as E,ac as G,r as i,o as L,a2 as m,e as O,f as g,h as l,w as t,V as k,i as u,q as P,s as x,v as C,t as r,a9 as B,n as F,p as s,G as f,W as N,ad as H,P as q,N as J,k as K,g as R,j as S,m as z,a4 as Q,M as X,ai as Z,aj as ee,a7 as A,T as ae,aa as te}from"./app-BU2Ar5cD.js";const le={class:"text-h3"},ne={class:"d-flex align-center"},re={__name:"CustomerWallet",setup(se){const p=E(),{alert:d}=G(),V=i(!1),b=i(!1),y=i(!1),D=i(0),M=i([]),c=i(0),o=i("bank_transfer"),v=i(""),W=[{title:"Date",key:"transaction_date"},{title:"Type",key:"transaction_type"},{title:"Amount",key:"amount"},{title:"Balance After",key:"balance_after"},{title:"Reference",key:"reference"},{title:"Status",key:"status"}],h=[{title:"Online Payment (Paystack)",value:"online",icon:"mdi-credit-card"},{title:"Bank Transfer",value:"bank_transfer",icon:"mdi-bank-transfer"},{title:"Cash Deposit",value:"cash",icon:"mdi-cash"}],w=n=>new Intl.NumberFormat("en-NG").format(n),U=n=>n==="credit"?"success":"error",I=n=>({pending:"warning",completed:"success",reversed:"error"})[n]||"default",_=async()=>{V.value=!0;try{const[n,e]=await Promise.all([m.get(`/api/wallet/customers/${p.user.id}/balance`),m.get("/api/wallet/transactions",{params:{customer_id:p.user.id}})]);D.value=n.data.balance,M.value=e.data.data||e.data}catch(n){console.error("Failed to load wallet data:",n)}finally{V.value=!1}},T=()=>{y.value=!1,c.value=100,o.value="online",v.value=""},Y=async()=>{var n,e;b.value=!0;try{if(o.value==="online"){const a=await m.post("/api/payments/initialize",{customer_id:p.user.id,amount:c.value,description:"Wallet funding via online payment",metadata:{source:"customer_portal"}});a.data.status?window.location.href=a.data.data.authorization_url:d(a.data.message||"Failed to initialize payment")}else await m.post("/api/wallet/fund",{customer_id:p.user.id,amount:c.value,payment_method:o.value,reference:v.value,notes:"Customer self-service wallet funding"}),T(),_(),d("Funding request submitted successfully. Your wallet will be credited after verification.")}catch(a){console.error("Failed to submit funding request:",a),d(((e=(n=a.response)==null?void 0:n.data)==null?void 0:e.message)||"Failed to submit funding request. Please try again.")}finally{b.value=!1}};L(()=>{_();const n=new URLSearchParams(window.location.search),e=n.get("reference"),a=n.get("status");e&&a==="success"?$(e):e&&a==="cancelled"&&(d("Payment was cancelled"),window.history.replaceState({},document.title,window.location.pathname))});const $=async n=>{try{const e=await m.post("/api/payments/verify",{reference:n});e.data.status?(d(`Payment successful! ₦${w(e.data.data.amount)} has been credited to your wallet.`),_()):d("Payment verification failed. Please contact support if amount was deducted.")}catch(e){console.error("Payment verification error:",e),d("Payment verification failed. Please contact support.")}finally{window.history.replaceState({},document.title,window.location.pathname)}};return(n,e)=>(g(),O("div",null,[l(P,null,{default:t(()=>[l(k,{cols:"12"},{default:t(()=>[...e[5]||(e[5]=[u("h1",{class:"text-h4 mb-4"},"My Wallet",-1)])]),_:1})]),_:1}),l(P,null,{default:t(()=>[l(k,{cols:"12",md:"6"},{default:t(()=>[l(x,{color:"primary",dark:""},{default:t(()=>[l(C,null,{default:t(()=>[e[6]||(e[6]=u("div",{class:"text-caption"},"Current Balance",-1)),u("div",le,"₦"+r(w(D.value)),1)]),_:1}),l(B,null,{default:t(()=>[l(F,{variant:"outlined",onClick:e[0]||(e[0]=a=>y.value=!0)},{default:t(()=>[l(f,{left:""},{default:t(()=>[...e[7]||(e[7]=[s("mdi-plus-circle",-1)])]),_:1}),e[8]||(e[8]=s(" Fund Wallet ",-1))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(P,{class:"mt-4"},{default:t(()=>[l(k,{cols:"12"},{default:t(()=>[l(x,null,{default:t(()=>[l(N,null,{default:t(()=>[...e[9]||(e[9]=[s("Transaction History",-1)])]),_:1}),l(C,null,{default:t(()=>[l(H,{headers:W,items:M.value,loading:V.value},{"item.transaction_date":t(({item:a})=>[s(r(a.transaction_date),1)]),"item.transaction_type":t(({item:a})=>[l(q,{color:U(a.transaction_type),size:"small"},{default:t(()=>[s(r(a.transaction_type),1)]),_:2},1032,["color"])]),"item.amount":t(({item:a})=>[u("span",{class:J(a.transaction_type==="credit"?"text-success":"text-error")},r(a.transaction_type==="credit"?"+":"-")+"₦"+r(w(a.amount)),3)]),"item.balance_after":t(({item:a})=>[s(" ₦"+r(w(a.balance_after)),1)]),"item.status":t(({item:a})=>[l(q,{color:I(a.status),size:"small"},{default:t(()=>[s(r(a.status),1)]),_:2},1032,["color"])]),_:1},8,["items","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),l(te,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=a=>y.value=a),"max-width":"600px",persistent:""},{default:t(()=>[l(x,null,{default:t(()=>[l(N,{class:"bg-primary text-white"},{default:t(()=>[l(f,{start:""},{default:t(()=>[...e[10]||(e[10]=[s("mdi-wallet-plus",-1)])]),_:1}),e[11]||(e[11]=s(" Fund Wallet ",-1))]),_:1}),l(C,{class:"pt-6"},{default:t(()=>[l(K,{ref:"fundForm"},{default:t(()=>[l(z,{modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=a=>c.value=a),modelModifiers:{number:!0},label:"Amount *",type:"number",min:"100",variant:"outlined",prefix:"₦",rules:[a=>a>=100||"Minimum amount is ₦100",a=>a<=1e7||"Maximum amount is ₦10,000,000"],hint:"Minimum: ₦100"},null,8,["modelValue","rules"]),l(Q,{modelValue:o.value,"onUpdate:modelValue":e[2]||(e[2]=a=>o.value=a),items:h,label:"Payment Method *",variant:"outlined",rules:[a=>!!a||"Required"]},{item:t(({props:a,item:j})=>[l(X,Z(ee(a)),{prepend:t(()=>[l(f,{icon:j.raw.icon},null,8,["icon"])]),_:2},1040)]),_:1},8,["modelValue","rules"]),o.value==="online"?(g(),R(A,{key:0,type:"info",variant:"tonal",class:"mt-2"},{default:t(()=>[u("div",ne,[l(f,{start:""},{default:t(()=>[...e[12]||(e[12]=[s("mdi-information",-1)])]),_:1}),e[13]||(e[13]=u("div",null,[u("strong",null,"Secure Online Payment"),u("p",{class:"text-caption mb-0"},"You will be redirected to our payment gateway to complete your transaction securely.")],-1))])]),_:1})):S("",!0),o.value!=="online"?(g(),R(z,{key:1,modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=a=>v.value=a),label:"Payment Reference *",variant:"outlined",rules:[a=>!!a||"Required"],hint:"Enter your bank transfer reference or transaction ID"},null,8,["modelValue","rules"])):S("",!0),o.value!=="online"?(g(),R(A,{key:2,type:"warning",variant:"tonal",class:"mt-2"},{default:t(()=>[...e[14]||(e[14]=[s(" Your wallet will be credited after payment verification by our team ",-1)])]),_:1})):S("",!0)]),_:1},512)]),_:1}),l(B,null,{default:t(()=>[l(ae),l(F,{onClick:T},{default:t(()=>[...e[15]||(e[15]=[s("Cancel",-1)])]),_:1}),l(F,{color:"primary",onClick:Y,loading:b.value,variant:"flat"},{default:t(()=>[l(f,{start:""},{default:t(()=>[s(r(o.value==="online"?"mdi-credit-card":"mdi-check"),1)]),_:1}),s(" "+r(o.value==="online"?"Pay Now":"Submit Request"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{re as default};
