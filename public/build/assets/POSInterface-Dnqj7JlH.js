import{c as j,r as g,B as se,g as x,f,w as l,h as e,s as F,W as Z,i as r,n as V,G as b,p as i,H as ee,v as A,e as q,j as G,a7 as we,t as v,N as me,J as X,K as Y,q as D,V as _,a4 as ne,m as K,a8 as $e,a9 as ge,T as ye,aa as Se,b as he,A as Pe,o as Ae,a2 as W,ab as ze,I as ce,M as pe,Z as fe,_ as ve,P as ae,O as Ue}from"./app-BU2Ar5cD.js";import{u as qe}from"./useToast-CtmKKjnB.js";import{S as Te}from"./SaleReceipt-PrLSNNe8.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./appSettings-IvybmRna.js";const Me={class:"d-flex justify-space-between align-center"},Re={class:"text-h5 font-weight-bold"},Ie={class:"d-flex justify-space-between align-center mt-2"},Ne={class:"d-flex justify-space-between align-center mt-2"},Be={class:"mb-4"},De={class:"d-flex justify-space-between align-center mb-3"},Fe={key:0,class:"mb-4"},je={__name:"SplitPaymentDialog",props:{modelValue:Boolean,totalAmount:{type:Number,required:!0}},emits:["update:modelValue","confirm"],setup(J,{emit:L}){const T=J,Q=L,E=j({get:()=>T.modelValue,set:c=>Q("update:modelValue",c)}),p=g([{payment_method:"cash",amount:0,reference:""}]),M=[{title:"Cash",value:"cash"},{title:"Card",value:"card"},{title:"Bank Transfer",value:"bank_transfer"},{title:"Wallet",value:"wallet"}],w=j(()=>p.value.reduce((c,s)=>c+(parseFloat(s.amount)||0),0)),$=j(()=>Math.max(0,T.totalAmount-w.value)),u=j(()=>{const c=p.value.every(d=>d.payment_method&&d.amount>0),s=w.value>=T.totalAmount;return c&&s}),R=()=>{p.value.length<4&&p.value.push({payment_method:"cash",amount:$.value,reference:""})},I=c=>{p.value.length>1&&p.value.splice(c,1)},z=c=>{const s=p.value.findIndex(d=>d.payment_method===c&&d.amount===0);s>=0?p.value[s].amount=$.value:p.value.push({payment_method:c,amount:$.value,reference:""})},k=()=>{u.value&&(Q("confirm",p.value),S())},S=()=>{E.value=!1,setTimeout(()=>{p.value=[{payment_method:"cash",amount:0,reference:""}]},300)},h=c=>!c&&c!==0?"₦0.00":`₦${parseFloat(c).toLocaleString("en-NG",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return se(()=>T.modelValue,c=>{c&&p.value.length===1&&p.value[0].amount===0&&(p.value[0].amount=T.totalAmount)}),(c,s)=>(f(),x(Se,{modelValue:E.value,"onUpdate:modelValue":s[4]||(s[4]=d=>E.value=d),"max-width":"700px",persistent:""},{default:l(()=>[e(F,null,{default:l(()=>[e(Z,{class:"d-flex justify-space-between align-center bg-primary"},{default:l(()=>[s[6]||(s[6]=r("span",{class:"text-white"},"Split Payment",-1)),e(V,{icon:"",variant:"text",onClick:S,color:"white"},{default:l(()=>[e(b,null,{default:l(()=>[...s[5]||(s[5]=[i("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),e(ee),e(A,{class:"pa-6"},{default:l(()=>[e(we,{type:"info",variant:"tonal",class:"mb-4"},{default:l(()=>[r("div",Me,[s[7]||(s[7]=r("span",{class:"text-h6"},"Total Amount:",-1)),r("span",Re,v(h(J.totalAmount)),1)]),r("div",Ie,[s[8]||(s[8]=r("span",null,"Amount Paid:",-1)),r("span",{class:me(["font-weight-bold",w.value>=J.totalAmount?"text-success":"text-warning"])},v(h(w.value)),3)]),r("div",Ne,[s[9]||(s[9]=r("span",null,"Remaining:",-1)),r("span",{class:me(["font-weight-bold",$.value>0?"text-error":"text-success"])},v(h($.value)),3)])]),_:1}),r("div",Be,[r("div",De,[s[11]||(s[11]=r("h3",{class:"text-h6"},"Payment Methods",-1)),e(V,{color:"primary",size:"small","prepend-icon":"mdi-plus",onClick:R,disabled:p.value.length>=4},{default:l(()=>[...s[10]||(s[10]=[i(" Add Payment ",-1)])]),_:1},8,["disabled"])]),(f(!0),q(X,null,Y(p.value,(d,O)=>(f(),x(F,{key:O,class:"mb-3",variant:"outlined"},{default:l(()=>[e(A,null,{default:l(()=>[e(D,null,{default:l(()=>[e(_,{cols:"12",md:"5"},{default:l(()=>[e(ne,{modelValue:d.payment_method,"onUpdate:modelValue":y=>d.payment_method=y,items:M,label:"Payment Method",variant:"outlined",density:"compact",rules:[y=>!!y||"Payment method is required"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1024),e(_,{cols:"12",md:"5"},{default:l(()=>[e(K,{modelValue:d.amount,"onUpdate:modelValue":y=>d.amount=y,modelModifiers:{number:!0},label:"Amount",type:"number",variant:"outlined",density:"compact",prefix:"₦",rules:[y=>!!y||"Amount is required",y=>y>0||"Amount must be greater than 0"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1024),e(_,{cols:"12",md:"2",class:"d-flex align-center"},{default:l(()=>[e(V,{icon:"",size:"small",color:"error",variant:"text",onClick:y=>I(O),disabled:p.value.length===1},{default:l(()=>[e(b,null,{default:l(()=>[...s[12]||(s[12]=[i("mdi-delete",-1)])]),_:1})]),_:1},8,["onClick","disabled"])]),_:2},1024),d.payment_method==="bank_transfer"?(f(),x(_,{key:0,cols:"12"},{default:l(()=>[e(K,{modelValue:d.reference,"onUpdate:modelValue":y=>d.reference=y,label:"Transfer Reference (Optional)",variant:"outlined",density:"compact","prepend-inner-icon":"mdi-receipt"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):G("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),$.value>0?(f(),q("div",Fe,[s[21]||(s[21]=r("p",{class:"text-caption mb-2"},"Quick Add Remaining:",-1)),e($e,{density:"compact"},{default:l(()=>[e(V,{size:"small",onClick:s[0]||(s[0]=d=>z("cash"))},{default:l(()=>[e(b,{left:"",size:"small"},{default:l(()=>[...s[13]||(s[13]=[i("mdi-cash",-1)])]),_:1}),s[14]||(s[14]=i(" Cash ",-1))]),_:1}),e(V,{size:"small",onClick:s[1]||(s[1]=d=>z("card"))},{default:l(()=>[e(b,{left:"",size:"small"},{default:l(()=>[...s[15]||(s[15]=[i("mdi-credit-card",-1)])]),_:1}),s[16]||(s[16]=i(" Card ",-1))]),_:1}),e(V,{size:"small",onClick:s[2]||(s[2]=d=>z("bank_transfer"))},{default:l(()=>[e(b,{left:"",size:"small"},{default:l(()=>[...s[17]||(s[17]=[i("mdi-bank-transfer",-1)])]),_:1}),s[18]||(s[18]=i(" Transfer ",-1))]),_:1}),e(V,{size:"small",onClick:s[3]||(s[3]=d=>z("wallet"))},{default:l(()=>[e(b,{left:"",size:"small"},{default:l(()=>[...s[19]||(s[19]=[i("mdi-wallet",-1)])]),_:1}),s[20]||(s[20]=i(" Wallet ",-1))]),_:1})]),_:1})])):G("",!0)]),_:1}),e(ee),e(ge,{class:"pa-4"},{default:l(()=>[e(ye),e(V,{color:"grey",variant:"text",onClick:S},{default:l(()=>[...s[22]||(s[22]=[i("Cancel",-1)])]),_:1}),e(V,{color:"success",variant:"flat",onClick:k,disabled:!u.value,"prepend-icon":"mdi-check"},{default:l(()=>[...s[23]||(s[23]=[i(" Confirm Payment ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Le=_e(je,[["__scopeId","data-v-8624e86f"]]),Qe={class:"text-subtitle-2"},Oe={class:"text-caption text-grey"},We={class:"text-subtitle-2 mt-2"},Ge={class:"text-caption text-grey"},Ke={key:0,class:"text-caption text-grey mb-1"},Ee={class:"text-decoration-line-through"},He={class:"text-caption text-grey"},Je={key:1,class:"text-center text-grey py-8"},Ze={__name:"POSInterface",setup(J){const L=he(),{success:T,handleError:Q}=qe(),{smAndDown:E}=Pe(),p=j(()=>E.value),M=g(""),w=g([]),$=g([]),u=g([]),R=g(0),I=g(0),z=g("cash"),k=g(null),S=g(null),h=g([]),c=g(!1),s=g(!1),d=g(null),O=g(!1),y=g([]),H=g(!1),N=g(null),Ve=[{title:"Cash",value:"cash"},{title:"Bank Transfer",value:"bank_transfer"},{title:"Card",value:"card"},{title:"Wallet",value:"wallet"}],ie=j(()=>u.value.reduce((n,t)=>n+t.quantity*t.selling_price,0)),le=j(()=>ie.value-R.value+I.value),U=n=>new Intl.NumberFormat("en-NG").format(n),oe=async()=>{if(M.value.length<2){w.value=[];return}try{const n=await W.get("/api/products",{params:{search:M.value}});w.value=n.data.data||n.data}catch(n){console.error("Search failed:",n)}},ue=async n=>{let t=n.selling_price,a="default";if(k.value)try{const o=h.value.find(B=>B.id===k.value),P=(await W.get(`/api/customers/${k.value}/pricing`)).data.find(B=>B.product_id===n.id);P&&P.special_price?(t=P.special_price,a="customer_special",console.log(`Applied customer special price for ${n.name}: ₦${t}`)):(o==null?void 0:o.category)==="wholesaler"&&n.wholesale_price?(t=n.wholesale_price,a="wholesaler",console.log(`Applied wholesaler price for ${n.name}: ₦${t}`)):(o==null?void 0:o.category)==="retailer"&&n.retailer_price&&(t=n.retailer_price,a="retailer",console.log(`Applied retailer price for ${n.name}: ₦${t}`))}catch(o){console.error("Failed to get customer pricing:",o)}const m=u.value.find(o=>o.id===n.id);m?(m.quantity++,m.selling_price!==t&&(m.selling_price=t,m.original_price=n.selling_price,console.log(`Updated price for existing item ${n.name}: ₦${t}`))):(u.value.push({...n,quantity:1,selling_price:t,original_price:n.selling_price,price_source:a}),console.log(`Added ${n.name} to cart at ₦${t} (${a})`)),N.value=n,p.value&&(H.value=!0),M.value="",w.value=[]},be=n=>{u.value.splice(n,1)},xe=n=>{u.value[n].quantity<1&&(u.value[n].quantity=1)},re=()=>{u.value=[],R.value=0,I.value=0,H.value=!1,N.value=null,S.value&&(k.value=S.value.id)},ke=n=>{y.value=n,de(n)},Ce=async()=>{de(null)},de=async(n=null)=>{var a,m;let t=(a=L.user)==null?void 0:a.store_id;if(!t&&((m=L.user)!=null&&m.stores)&&L.user.stores.length>0&&(t=L.user.stores[0].id),!t){Q({response:{data:{message:"No store assigned to your account. Please contact administrator."}}});return}if(u.value.length===0){Q({response:{data:{message:"Cart is empty. Please add items to cart."}}});return}c.value=!0;try{const o={customer_id:k.value,store_id:t,sale_type:"pos",discount_amount:R.value,tax_amount:I.value,amount_paid:le.value,items:u.value.map(P=>({product_id:P.id,quantity:P.quantity,unit_id:P.unit_id||null,unit_price:P.selling_price}))};n&&n.length>0?(o.payments=n,o.payment_method="mixed"):o.payment_method=z.value;const C=await W.post("/api/sales",o);T("Sale completed successfully!"),d.value=C.data.sale,s.value=!0,re(),y.value=[]}catch(o){console.error("Sale failed:",o),Q(o,"Failed to complete sale")}finally{c.value=!1}};return se(k,async(n,t)=>{if(!n||n===t||u.value.length===0){console.log("Customer watcher: skipping update",{newCustomerId:n,oldCustomerId:t,cartLength:u.value.length});return}console.log(`Customer changed from ${t} to ${n}, updating ${u.value.length} cart items...`);for(const a of u.value){let m=a.original_price||a.selling_price,o="default";try{const C=h.value.find(te=>te.id===n),B=(await W.get(`/api/customers/${n}/pricing`)).data.find(te=>te.product_id===a.id);B&&B.special_price?(m=B.special_price,o="customer_special"):(C==null?void 0:C.category)==="wholesaler"&&a.wholesale_price?(m=a.wholesale_price,o="wholesaler"):(C==null?void 0:C.category)==="retailer"&&a.retailer_price&&(m=a.retailer_price,o="retailer"),console.log(`Updated ${a.name}: ₦${a.selling_price} → ₦${m} (${o})`)}catch(C){console.error("Failed to get customer pricing:",C)}a.selling_price=m,a.price_source=o}}),se(u,n=>{n.length||(H.value=!1,N.value=null)}),Ae(async()=>{const n=await W.get("/api/products",{params:{per_page:8}});$.value=n.data.data||n.data;const t=await W.get("/api/customers");h.value=t.data.data||t.data,S.value=h.value.find(a=>a.code==="CUST00000"),S.value&&(k.value=S.value.id)}),(n,t)=>(f(),q("div",null,[e(Te,{modelValue:s.value,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value=a),sale:d.value},null,8,["modelValue","sale"]),e(Le,{modelValue:O.value,"onUpdate:modelValue":t[1]||(t[1]=a=>O.value=a),"total-amount":le.value,onConfirm:ke},null,8,["modelValue","total-amount"]),e(D,null,{default:l(()=>[e(_,{cols:"12",md:"8"},{default:l(()=>[e(F,{class:"mb-4"},{default:l(()=>[e(A,null,{default:l(()=>[e(K,{modelValue:M.value,"onUpdate:modelValue":t[2]||(t[2]=a=>M.value=a),label:"Search Product (Name, SKU, or Barcode)","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",autofocus:"",onKeyup:ze(oe,["enter"]),onInput:oe},null,8,["modelValue"]),w.value.length>0?(f(),x(ce,{key:0,class:"mt-2"},{default:l(()=>[(f(!0),q(X,null,Y(w.value,a=>(f(),x(pe,{key:a.id,onClick:m=>ue(a),class:"cursor-pointer"},{prepend:l(()=>[e(b,null,{default:l(()=>[...t[9]||(t[9]=[i("mdi-package-variant",-1)])]),_:1})]),append:l(()=>[e(ae,{size:"small",color:"primary"},{default:l(()=>[i("Stock: "+v(a.stock_quantity||0),1)]),_:2},1024)]),default:l(()=>[e(fe,null,{default:l(()=>[i(v(a.name),1)]),_:2},1024),e(ve,null,{default:l(()=>[i(v(a.sku)+" - ₦"+v(U(a.selling_price)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})):G("",!0)]),_:1})]),_:1}),p.value&&H.value&&N.value?(f(),x(F,{key:0,class:"mb-4"},{default:l(()=>[e(Z,{class:"d-flex align-center justify-space-between"},{default:l(()=>[t[11]||(t[11]=r("span",null,"Quick Select",-1)),e(V,{variant:"text",size:"small",onClick:t[3]||(t[3]=a=>H.value=!1)},{default:l(()=>[...t[10]||(t[10]=[i("Change",-1)])]),_:1})]),_:1}),e(A,{class:"d-flex align-center justify-space-between"},{default:l(()=>[r("div",null,[r("div",Qe,v(N.value.name),1),r("div",Oe," ₦"+v(U(N.value.selling_price)),1)]),e(ae,{size:"small",color:"primary"},{default:l(()=>{var a;return[i(" Qty: "+v(((a=u.value.find(m=>m.id===N.value.id))==null?void 0:a.quantity)||0),1)]}),_:1})]),_:1})]),_:1})):(f(),x(F,{key:1},{default:l(()=>[e(Z,null,{default:l(()=>[...t[12]||(t[12]=[i("Quick Select",-1)])]),_:1}),e(A,null,{default:l(()=>[e(D,null,{default:l(()=>[(f(!0),q(X,null,Y($.value,a=>(f(),x(_,{key:a.id,cols:"6",md:"3"},{default:l(()=>[e(F,{onClick:m=>ue(a),class:"cursor-pointer hover:shadow-lg",variant:"outlined"},{default:l(()=>[e(A,{class:"text-center"},{default:l(()=>[e(b,{size:"48",color:"primary"},{default:l(()=>[...t[13]||(t[13]=[i("mdi-package-variant",-1)])]),_:1}),r("div",We,v(a.name),1),r("div",Ge,"₦"+v(U(a.selling_price)),1)]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}))]),_:1}),e(_,{cols:"12",md:"4"},{default:l(()=>[e(F,null,{default:l(()=>[e(Z,{class:"bg-primary text-white"},{default:l(()=>[t[15]||(t[15]=i(" Shopping Cart ",-1)),e(ye),u.value.length>0?(f(),x(V,{key:0,icon:"",size:"small",onClick:re},{default:l(()=>[e(b,null,{default:l(()=>[...t[14]||(t[14]=[i("mdi-delete",-1)])]),_:1})]),_:1})):G("",!0)]),_:1}),e(A,{style:{"max-height":"400px","overflow-y":"auto"}},{default:l(()=>[u.value.length>0?(f(),x(ce,{key:0},{default:l(()=>[(f(!0),q(X,null,Y(u.value,(a,m)=>(f(),x(pe,{key:m},{append:l(()=>[e(V,{icon:"",size:"small",onClick:o=>be(m)},{default:l(()=>[e(b,null,{default:l(()=>[...t[17]||(t[17]=[i("mdi-close",-1)])]),_:1})]),_:1},8,["onClick"])]),default:l(()=>[e(fe,null,{default:l(()=>[i(v(a.name)+" ",1),a.selling_price!==a.original_price?(f(),x(ae,{key:0,size:"x-small",color:"success",class:"ml-2"},{default:l(()=>[...t[16]||(t[16]=[i(" Special Price ",-1)])]),_:1})):G("",!0)]),_:2},1024),e(ve,null,{default:l(()=>[a.selling_price!==a.original_price?(f(),q("div",Ke,[r("span",Ee,"₦"+v(U(a.original_price)),1),i(" → ₦"+v(U(a.selling_price)),1)])):G("",!0),e(D,{align:"center",class:"mt-2"},{default:l(()=>[e(_,{cols:"6"},{default:l(()=>[e(K,{modelValue:a.quantity,"onUpdate:modelValue":o=>a.quantity=o,modelModifiers:{number:!0},type:"number",min:"1",density:"compact",variant:"outlined","hide-details":"",onInput:o=>xe(m)},Ue({_:2},[a.unit?{name:"append-inner",fn:l(()=>{var o;return[r("span",He,v((o=a.unit)==null?void 0:o.short_name),1)]}),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),e(_,{cols:"6",class:"text-right"},{default:l(()=>[i(" ₦"+v(U(a.quantity*a.selling_price)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):(f(),q("div",Je,[e(b,{size:"64"},{default:l(()=>[...t[18]||(t[18]=[i("mdi-cart-outline",-1)])]),_:1}),t[19]||(t[19]=r("div",{class:"mt-2"},"Cart is empty",-1))]))]),_:1}),e(ee),e(A,null,{default:l(()=>[e(D,null,{default:l(()=>[e(_,{cols:"6"},{default:l(()=>[...t[20]||(t[20]=[i("Subtotal:",-1)])]),_:1}),e(_,{cols:"6",class:"text-right font-weight-bold"},{default:l(()=>[i("₦"+v(U(ie.value)),1)]),_:1})]),_:1}),e(D,null,{default:l(()=>[e(_,{cols:"6"},{default:l(()=>[e(K,{modelValue:R.value,"onUpdate:modelValue":t[4]||(t[4]=a=>R.value=a),modelModifiers:{number:!0},label:"Discount",type:"number",min:"0",density:"compact",variant:"outlined","hide-details":"",prefix:"₦"},null,8,["modelValue"])]),_:1}),e(_,{cols:"6"},{default:l(()=>[e(K,{modelValue:I.value,"onUpdate:modelValue":t[5]||(t[5]=a=>I.value=a),modelModifiers:{number:!0},label:"Tax",type:"number",min:"0",density:"compact",variant:"outlined","hide-details":"",prefix:"₦"},null,8,["modelValue"])]),_:1})]),_:1}),e(D,{class:"mt-4"},{default:l(()=>[e(_,{cols:"6",class:"text-h6"},{default:l(()=>[...t[21]||(t[21]=[i("Total:",-1)])]),_:1}),e(_,{cols:"6",class:"text-right text-h6 text-primary"},{default:l(()=>[i("₦"+v(U(le.value)),1)]),_:1})]),_:1})]),_:1}),e(ee),e(A,null,{default:l(()=>[e(ne,{modelValue:z.value,"onUpdate:modelValue":t[6]||(t[6]=a=>z.value=a),items:Ve,label:"Payment Method",variant:"outlined",density:"compact"},null,8,["modelValue"]),e(ne,{modelValue:k.value,"onUpdate:modelValue":t[7]||(t[7]=a=>k.value=a),items:h.value,"item-title":"name","item-value":"id",label:"Customer (Optional)",variant:"outlined",density:"compact",clearable:"",class:"mt-2"},null,8,["modelValue","items"])]),_:1}),e(ge,{class:"flex-column pa-4"},{default:l(()=>[e(V,{block:"",color:"success",size:"large",disabled:u.value.length===0,loading:c.value,onClick:Ce,class:"mb-2"},{default:l(()=>[e(b,{left:""},{default:l(()=>[...t[22]||(t[22]=[i("mdi-cash-register",-1)])]),_:1}),t[23]||(t[23]=i(" Complete Sale ",-1))]),_:1},8,["disabled","loading"]),e(V,{block:"",color:"primary",size:"large",variant:"outlined",disabled:u.value.length===0,onClick:t[8]||(t[8]=a=>O.value=!0)},{default:l(()=>[e(b,{left:""},{default:l(()=>[...t[24]||(t[24]=[i("mdi-cash-multiple",-1)])]),_:1}),t[25]||(t[25]=i(" Split Payment ",-1))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]))}},al=_e(Ze,[["__scopeId","data-v-8a9b2fe2"]]);export{al as default};
